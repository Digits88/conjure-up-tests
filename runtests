#!/bin/bash

set -eu

. ./common.sh

: ${CHANNEL:=edge}
: ${TIMEOUT:=30m}

log "Checking latest conjure-up from $CHANNEL release"
if ! snap info conjure-up|grep -q "installed"; then
    sudo snap install conjure-up --classic --$CHANNEL
else
    sudo snap refresh conjure-up --classic --$CHANNEL
fi

export JUJU_MODEL=conjure-up-test
export JUJU_CONTROLLER=conjure-up-controller

spells=(kubernetes-core \
            canonical-kubernetes \
            openstack-novalxd \
            hadoop-kafka \
            hadoop-processing \
            hadoop-spark \
            realtime-syslog-analytics \
            spark-processing \
            ghost)

for spell in ${spells[@]}; do
    log ""
    log "Running $spell deployment"
    log ""
    timeout -s INT $TIMEOUT conjure-up --notrack $spell localhost $JUJU_CONTROLLER $JUJU_MODEL
    if [ -f $spell.verify ]; then
        log "Verifying deployment of $spell"
        ./$spell.verify
    fi
    conjure-down $JUJU_CONTROLLER $JUJU_MODEL
    sleep 10
done
exit 0

juju kill-controller -y $JUJU_CONTROLLER
