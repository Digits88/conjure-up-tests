#!/bin/bash

set -eu

SPELLDIR=/snap/conjure-up/current/spells

# Override cloud to test
: "${CLOUD:=localhost}"

# Snap channel
: "${CHANNEL:=edge}"

export PATH=/snap/bin:$PATH
export CLOUD=$CLOUD
export DEBIAN_FRONTEND=noninteractive

sudo -E apt-get -qq update
sudo -E apt-get install -qyf -o Dpkg::Options::=--force-confdef -o Dpkg::Options::=--force-confold git python3-yaml cpanminus libstatgrab-dev make pkg-config|| true
# sudo -E apt-get -qyf -o Dpkg::Options::=--force-confdef -o Dpkg::Options::=--force-confold dist-upgrade

if ! snap info conjure-up|grep -q "installed"; then
    printf "Installing conjure-up from %s release\n" "$CHANNEL"
    sudo snap install conjure-up --classic --"$CHANNEL" > /dev/null 2>&1 || true
else
    printf "Upgrading conjure-up from %s release\n" "$CHANNEL"
    sudo snap refresh conjure-up --classic --"$CHANNEL" > /dev/null 2>&1 || true
fi

source $SPELLDIR/sdk/common.sh

testLog "Installing sprun"
sudo cpanm -n App::Prun::Scaled

testLog "Juju Version: $(conjure-up.juju version)"
testLog "LXD Version: $(conjure-up.lxd --version)"
testLog "$(conjure-up --version)"

testLog "Creating network bridges prior"
conjure-up.lxc network create conjureup0 ipv4.address=auto ipv6.address=none
conjure-up.lxc network create conjureup1 ipv4.address=auto ipv6.address=none

spells=(kubernetes-core \
            canonical-kubernetes \
            openstack-novalxd \
            hadoop-kafka \
            hadoop-processing \
            hadoop-spark \
            realtime-syslog-analytics \
            spark-processing \
            ghost)

testLog "Running spell tests"
for spell in "${spells[@]}"; do echo "conjure-up --notrack --noreport $spell $CLOUD"; done |sprun -e
exit 0
